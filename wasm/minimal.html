<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <title>颜色转换与图片取色</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, Helvetica, Arial,
          sans-serif;
        padding: 16px;
      }

      label {
        display: inline-block;
        width: 24px;
      }

      input[type="number"] {
        width: 80px;
      }

      .row {
        margin: 8px 0;
      }

      pre {
        background: #111;
        color: #eee;
        padding: 12px;
        border-radius: 6px;
      }

      button {
        padding: 6px 12px;
      }
    </style>
  </head>

  <body>
    <h2>rgb2oklch</h2>
    <div class="row">
      <label for="r">R</label>
      <input id="r" type="number" min="0" max="255" value="255" />
      <label for="g">G</label>
      <input id="g" type="number" min="0" max="255" value="0" />
      <label for="b">B</label>
      <input id="b" type="number" min="0" max="255" value="0" />
      <button id="run">转换</button>
    </div>
    <pre id="out">加载中...</pre>

    <h2 style="margin-top: 24px">oklch2rgb</h2>
    <div class="row">
      <label for="l">L</label>
      <input
        id="l"
        type="number"
        min="0"
        max="1"
        step="0.000001"
        value="0.62796"
      />
      <label for="c">C</label>
      <input id="c" type="number" min="0" step="0.000001" value="0.25754" />
      <label for="h">h</label>
      <input
        id="h"
        type="number"
        min="0"
        max="360"
        step="0.000001"
        value="29.23388"
      />
      <label for="rel" title="relative chroma (0..1)">rel</label>
      <input
        id="rel"
        type="number"
        min="0"
        max="1"
        step="0.000001"
        placeholder="(可选)"
      />
      <button id="run2">转换</button>
    </div>
    <pre id="out2">加载中...</pre>

    <script>
      // 纯原生加载 .wasm（不使用 Emscripten 生成的 JS）
      // 需要浏览器通过 HTTP(S) 提供正确的 MIME: application/wasm
      // 若 .wasm 是 WASI 构建，提供最小 wasi_snapshot_preview1 stub 以便在浏览器中实例化。
      let rgb2oklchExports, rgb2oklchMemory;
      let oklch2rgbExports, oklch2rgbMemory;
      let extractExports, extractMemory;

      // ---- 最小 WASI stub 与带回退的实例化工具 ----
      function createWasiStub(memory) {
        const encoder = new TextEncoder();
        // 简易写入：忽略内容，仅报告写入 0 字节，避免报错
        function fd_write(fd, iov, iovcnt, pOut) {
          try {
            const view = new DataView(memory.buffer);
            view.setUint32(pOut >>> 0, 0, true);
          } catch (_) {}
          return 0; // __WASI_ERRNO_SUCCESS
        }
        function ret0() {
          return 0;
        }
        function enosys() {
          return 52; // __WASI_ERRNO_ENOSYS
        }
        function proc_exit(code) {
          // 将 WASI 退出转为异常，避免整个页面崩溃
          throw new Error("WASI proc_exit: " + code);
        }
        return {
          args_get: ret0,
          args_sizes_get: function (pArgc, pArgvBufSize) {
            try {
              const view = new DataView(memory.buffer);
              view.setUint32(pArgc >>> 0, 0, true);
              view.setUint32(pArgvBufSize >>> 0, 0, true);
            } catch (_) {}
            return 0;
          },
          environ_get: ret0,
          environ_sizes_get: function (pCount, pBufSize) {
            try {
              const view = new DataView(memory.buffer);
              view.setUint32(pCount >>> 0, 0, true);
              view.setUint32(pBufSize >>> 0, 0, true);
            } catch (_) {}
            return 0;
          },
          fd_write,
          fd_close: ret0,
          fd_read: enosys,
          fd_seek: enosys,
          fd_fdstat_get: ret0,
          fd_fdstat_set_flags: ret0,
          fd_sync: ret0,
          fd_prestat_get: enosys,
          fd_prestat_dir_name: enosys,
          path_open: enosys,
          path_unlink_file: enosys,
          path_create_directory: enosys,
          path_remove_directory: enosys,
          path_readlink: enosys,
          path_filestat_get: enosys,
          fd_filestat_get: enosys,
          poll_oneoff: enosys,
          clock_time_get: ret0,
          random_get: function (ptr, len) {
            try {
              const dst = new Uint8Array(memory.buffer, ptr >>> 0, len >>> 0);
              crypto.getRandomValues(dst);
            } catch (_) {}
            return 0;
          },
          proc_exit,
        };
      }

      async function instantiateWasmWithFallback(url) {
        // 先尝试无需 imports 的实例化（适用于独立 wasm）
        try {
          const resp = await fetch(url);
          const source = resp.headers
            .get("content-type")
            ?.includes("application/wasm")
            ? WebAssembly.instantiateStreaming(fetch(url), {})
            : WebAssembly.instantiate(await resp.arrayBuffer(), {});
          return (await source).instance;
        } catch (e1) {
          // 回退：提供最小 WASI 与 env/imports
          const buf = await (await fetch(url)).arrayBuffer();
          // 预创建一块内存以备某些模块需要 env.memory 导入
          const memory = new WebAssembly.Memory({
            initial: 256,
            maximum: 16384,
          });
          const imports = {
            wasi_snapshot_preview1: createWasiStub(memory),
            env: {
              memory,
              abort: function () {},
              emscripten_notify_memory_growth: function () {},
            },
          };
          const { instance } = await WebAssembly.instantiate(buf, imports);
          return instance;
        }
      }

      async function loadRgb2OklchWasm() {
        try {
          const instance = await instantiateWasmWithFallback("rgb2oklch.wasm");
          rgb2oklchExports = instance.exports;
          rgb2oklchMemory = rgb2oklchExports.memory; // WebAssembly.Memory
          document.getElementById("out").textContent = "WASM 已加载";
        } catch (e) {
          document.getElementById("out").textContent = "加载 WASM 失败: " + e;
          console.error(e);
        }
      }

      async function loadOklch2RgbWasm() {
        try {
          const instance = await instantiateWasmWithFallback("oklch2rgb.wasm");
          oklch2rgbExports = instance.exports;
          oklch2rgbMemory = oklch2rgbExports.memory;
          document.getElementById("out2").textContent = "WASM 已加载";
        } catch (e) {
          document.getElementById("out2").textContent = "加载 WASM 失败: " + e;
          console.error(e);
        }
      }

      function rgb2oklch(r, g, b) {
        if (!rgb2oklchExports) {
          return "WASM 未就绪";
        }
        // 调用导出的 rgb2oklch_calc_js(r,g,b) -> 返回指向 3 个 double 的指针
        const ptr =
          rgb2oklchExports.rgb2oklch_calc_js(r | 0, g | 0, b | 0) >>> 0;
        const f64 = new Float64Array(rgb2oklchMemory.buffer, ptr, 3);
        let L = f64[0];
        let C = f64[1];
        let h = f64[2];
        // 与 C 程序一致的展示：6 位小数，去尾零，C≈0 时强制 h=0
        const tiny = 1e-15;
        const fmt = (x) => {
          if (Math.abs(x) < tiny) x = 0;
          let s = x.toFixed(6);
          // 去掉多余的 0 和小数点
          s = s.replace(/\.0+$/, "").replace(/(\.[0-9]*?)0+$/, "$1");
          return s;
        };
        if (Math.abs(C) < tiny) {
          C = 0;
          h = 0;
        }
        return `L ${fmt(L)}  C ${fmt(C)}  h ${fmt(h)}`;
      }

      document.getElementById("run").addEventListener("click", () => {
        const r = +document.getElementById("r").value;
        const g = +document.getElementById("g").value;
        const b = +document.getElementById("b").value;
        document.getElementById("out").textContent = rgb2oklch(r, g, b);
      });

      function oklch2rgb(L, C, h, rel) {
        if (!oklch2rgbExports) {
          return "WASM 未就绪";
        }
        // 如果提供了 rel（数字且在 [0,1]），则走相对色度导出；否则使用绝对 C 导出
        let ptr;
        if (Number.isFinite(rel)) {
          const r = Math.max(0, Math.min(1, rel));
          ptr = oklch2rgbExports.oklch2rgb_calc_rel_js(L, h, r) >>> 0;
        } else {
          ptr = oklch2rgbExports.oklch2rgb_calc_js(L, C, h) >>> 0;
        }
        const i32 = new Int32Array(oklch2rgbMemory.buffer, ptr, 3);
        const R = i32[0] | 0;
        const G = i32[1] | 0;
        const B = i32[2] | 0;
        return `R ${R}  G ${G}  B ${B}`;
      }

      document.getElementById("run2").addEventListener("click", () => {
        const L = +document.getElementById("l").value;
        const C = +document.getElementById("c").value;
        const H = +document.getElementById("h").value;
        const REL_RAW = document.getElementById("rel").value;
        const rel = REL_RAW === "" ? undefined : +REL_RAW;
        document.getElementById("out2").textContent = oklch2rgb(L, C, H, rel);
      });

      loadRgb2OklchWasm();
      loadOklch2RgbWasm();
    </script>

    <h2 style="margin-top: 24px">extract-colors</h2>
    <div class="row">
      <input id="file" type="file" accept="image/*" />
      <button id="extract">提取颜色</button>
    </div>
    <div
      class="row"
      style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap"
    >
      <div>
        <img
          id="preview"
          style="max-width: 360px; border: 1px solid #ccc; display: block"
        />
        <div style="font-size: 12px; color: #666; margin-top: 4px">
          预览（抽样与缩放由模块内部共享 Canvas 完成）
        </div>
      </div>
      <div style="min-width: 280px; flex: 1">
        <div
          id="swatches"
          style="display: flex; flex-wrap: wrap; gap: 8px"
        ></div>
        <pre id="extract-out" style="margin-top: 12px">加载中...</pre>
      </div>
    </div>

    <script type="module">
      import extractColors from "./extract-colors.js";

      // 初始提示
      document.getElementById("extract-out").textContent = "请选择图片";

      function renderSwatches(colors, elapsedMs) {
        const sw = document.getElementById("swatches");
        const out = document.getElementById("extract-out");
        sw.innerHTML = "";
        const fmt = (x) => {
          if (!Number.isFinite(x)) return "0";
          let s = x
            .toFixed(6)
            .replace(/\.0+$/, "")
            .replace(/(\.[0-9]*?)0+$/, "$1");
          return s;
        };
        const fmtTime = (ms) => {
          if (!Number.isFinite(ms)) return "0 ms";
          if (ms >= 1000) return (ms / 1000).toFixed(2) + " s";
          return Math.round(ms) + " ms";
        };
        // 按占比从高到低排序
        const sorted = [...colors].sort((a, b) => {
          const aa = Number.isFinite(a?.area) ? a.area : 0;
          const bb = Number.isFinite(b?.area) ? b.area : 0;
          return bb - aa;
        });
        sorted.forEach((c) => {
          const chip = document.createElement("div");
          chip.style.width = "48px";
          chip.style.height = "48px";
          chip.style.borderRadius = "6px";
          chip.style.border = "1px solid #ccc";
          chip.style.background = c.hex;
          chip.title = `${c.hex}\narea ${fmt(c.area)}`;
          sw.appendChild(chip);
        });
        const timing =
          elapsedMs != null ? `耗时 ${fmtTime(elapsedMs)}\n\n` : "";
        out.textContent = timing + JSON.stringify(sorted, null, 2);
      }

      // 交互：文件选择 -> 直接走模块内置的共享 Canvas 流程
      let _lastImage = null;
      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }
      document.getElementById("file").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const dataUrl = await readFileAsDataURL(f);
        _lastImage = await new Promise((resolve, reject) => {
          const im = new Image();
          im.onload = () => resolve(im);
          im.onerror = reject;
          im.src = dataUrl;
        });
        const preview = document.getElementById("preview");
        preview.src = dataUrl;
        document.getElementById(
          "extract-out"
        ).textContent = `已载入：${_lastImage.naturalWidth}×${_lastImage.naturalHeight}`;
      });

      document.getElementById("extract").addEventListener("click", () => {
        if (!_lastImage) {
          document.getElementById("extract-out").textContent = "请先选择图片";
          return;
        }
        const out = document.getElementById("extract-out");
        out.textContent = "提取中...";
        const t0 = performance.now();
        extractColors(_lastImage)
          .then((colors) => {
            const dt = performance.now() - t0;
            renderSwatches(colors, dt);
          })
          .catch((e) => {
            document.getElementById("extract-out").textContent =
              "提取失败: " + e;
            console.error(e);
          });
      });
    </script>
  </body>
</html>
