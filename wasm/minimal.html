<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <title>颜色转换与图片取色</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, Helvetica, Arial,
          sans-serif;
        padding: 16px;
      }

      label {
        display: inline-block;
        width: 24px;
      }

      input[type="number"] {
        width: 80px;
      }

      .row {
        margin: 8px 0;
      }

      pre {
        background: #111;
        color: #eee;
        padding: 12px;
        border-radius: 6px;
      }

      button {
        padding: 6px 12px;
      }
    </style>
  </head>

  <body>
    <h2>rgb2oklch</h2>
    <div class="row">
      <label for="r">R</label>
      <input id="r" type="number" min="0" max="255" value="255" />
      <label for="g">G</label>
      <input id="g" type="number" min="0" max="255" value="0" />
      <label for="b">B</label>
      <input id="b" type="number" min="0" max="255" value="0" />
      <button id="run">转换</button>
    </div>
    <pre id="out">加载中...</pre>

    <h2 style="margin-top: 24px">oklch2rgb</h2>
    <div class="row">
      <label for="l">L</label>
      <input
        id="l"
        type="number"
        min="0"
        max="1"
        step="0.000001"
        value="0.62796"
      />
      <label for="c">C</label>
      <input id="c" type="number" min="0" step="0.000001" value="0.25754" />
      <label for="h">h</label>
      <input
        id="h"
        type="number"
        min="0"
        max="360"
        step="0.000001"
        value="29.23388"
      />
      <label for="rel" title="relative chroma (0..1)">rel</label>
      <input
        id="rel"
        type="number"
        min="0"
        max="1"
        step="0.000001"
        placeholder="(可选)"
      />
      <button id="run2">转换</button>
    </div>
    <pre id="out2">加载中...</pre>

    <script type="module">
      import {
        init,
        rgb2oklch as roFn,
        oklch2rgb_abs,
        oklch2rgb_rel,
      } from "./color-convert.js";

      // 初始化 WASM 模块（统一）
      init()
        .then(() => {
          document.getElementById("out").textContent = "WASM 已加载";
          document.getElementById("out2").textContent = "WASM 已加载";
        })
        .catch((e) => {
          document.getElementById("out").textContent = "加载失败: " + e;
          document.getElementById("out2").textContent = "加载失败: " + e;
          console.error(e);
        });

      function fmtNum(x) {
        let v = x;
        if (Math.abs(v) < 1e-15) v = 0;
        let s = v
          .toFixed(6)
          .replace(/\.0+$/, "")
          .replace(/(\.[0-9]*?)0+$/, "$1");
        return s;
      }

      document.getElementById("run").addEventListener("click", () => {
        const r = +document.getElementById("r").value;
        const g = +document.getElementById("g").value;
        const b = +document.getElementById("b").value;
        const { L, C, h } = roFn(r, g, b);
        const _C = Math.abs(C) < 1e-15 ? 0 : C;
        const _h = _C === 0 ? 0 : h;
        document.getElementById("out").textContent = `L ${fmtNum(
          L
        )}  C ${fmtNum(_C)}  h ${fmtNum(_h)}`;
      });

      document.getElementById("run2").addEventListener("click", () => {
        const L = +document.getElementById("l").value;
        const C = +document.getElementById("c").value;
        const H = +document.getElementById("h").value;
        const REL_RAW = document.getElementById("rel").value;
        const rel = REL_RAW === "" ? undefined : +REL_RAW;
        const rgb = Number.isFinite(rel)
          ? oklch2rgb_rel(L, H, rel)
          : oklch2rgb_abs(L, C, H);
        document.getElementById(
          "out2"
        ).textContent = `R ${rgb.R}  G ${rgb.G}  B ${rgb.B}`;
      });
    </script>

    <h2 style="margin-top: 24px">extract-colors</h2>
    <div class="row">
      <input id="file" type="file" accept="image/*" />
      <button id="extract">提取颜色</button>
    </div>
    <div
      class="row"
      style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap"
    >
      <div>
        <img
          id="preview"
          style="max-width: 360px; border: 1px solid #ccc; display: block"
        />
        <div style="font-size: 12px; color: #666; margin-top: 4px">
          预览（抽样与缩放由模块内部共享 Canvas 完成）
        </div>
      </div>
      <div style="min-width: 280px; flex: 1">
        <div
          id="swatches"
          style="display: flex; flex-wrap: wrap; gap: 8px"
        ></div>
        <pre id="extract-out" style="margin-top: 12px">加载中...</pre>
      </div>
    </div>

    <script type="module">
      import extractColors from "./extract-colors.js";

      // 初始提示
      document.getElementById("extract-out").textContent = "请选择图片";

      function renderSwatches(colors, elapsedMs) {
        const sw = document.getElementById("swatches");
        const out = document.getElementById("extract-out");
        sw.innerHTML = "";
        const fmt = (x) => {
          if (!Number.isFinite(x)) return "0";
          let s = x
            .toFixed(6)
            .replace(/\.0+$/, "")
            .replace(/(\.[0-9]*?)0+$/, "$1");
          return s;
        };
        const fmtTime = (ms) => {
          if (!Number.isFinite(ms)) return "0 ms";
          if (ms >= 1000) return (ms / 1000).toFixed(2) + " s";
          return Math.round(ms) + " ms";
        };
        // 按占比从高到低排序
        const sorted = [...colors].sort((a, b) => {
          const aa = Number.isFinite(a?.area) ? a.area : 0;
          const bb = Number.isFinite(b?.area) ? b.area : 0;
          return bb - aa;
        });
        sorted.forEach((c) => {
          const chip = document.createElement("div");
          chip.style.width = "48px";
          chip.style.height = "48px";
          chip.style.borderRadius = "6px";
          chip.style.border = "1px solid #ccc";
          chip.style.background = c.hex;
          chip.title = `${c.hex}\narea ${fmt(c.area)}`;
          sw.appendChild(chip);
        });
        const timing =
          elapsedMs != null ? `耗时 ${fmtTime(elapsedMs)}\n\n` : "";
        out.textContent = timing + JSON.stringify(sorted, null, 2);
      }

      // 交互：文件选择 -> 直接走模块内置的共享 Canvas 流程
      let _lastImage = null;
      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }
      document.getElementById("file").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const dataUrl = await readFileAsDataURL(f);
        _lastImage = await new Promise((resolve, reject) => {
          const im = new Image();
          im.onload = () => resolve(im);
          im.onerror = reject;
          im.src = dataUrl;
        });
        const preview = document.getElementById("preview");
        preview.src = dataUrl;
        document.getElementById(
          "extract-out"
        ).textContent = `已载入：${_lastImage.naturalWidth}×${_lastImage.naturalHeight}`;
      });

      document.getElementById("extract").addEventListener("click", () => {
        if (!_lastImage) {
          document.getElementById("extract-out").textContent = "请先选择图片";
          return;
        }
        const out = document.getElementById("extract-out");
        out.textContent = "提取中...";
        const t0 = performance.now();
        extractColors(_lastImage)
          .then((colors) => {
            const dt = performance.now() - t0;
            renderSwatches(colors, dt);
          })
          .catch((e) => {
            document.getElementById("extract-out").textContent =
              "提取失败: " + e;
            console.error(e);
          });
      });
    </script>
  </body>
</html>
